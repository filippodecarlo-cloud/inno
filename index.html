<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Inno Player">
    <meta name="theme-color" content="#764ba2">
    <meta name="description" content="Player audio per l'inno con controllo volume progressivo">

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <title>Riproduttore Inno</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .track-info {
            margin-bottom: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            border-left: 4px solid #764ba2;
        }

        .track-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .track-subtitle {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .track-artist {
            font-size: 11px;
            color: #888;
            font-style: italic;
            margin-bottom: 8px;
        }

        .track-description {
            font-size: 11px;
            color: #764ba2;
            font-weight: 500;
            line-height: 1.4;
        }

        .controls-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }

        #playButton {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            font-size: 40px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        #playButton:active {
            transform: scale(0.95);
        }

        #playButton:hover {
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        #playButton.playing {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        #restartButton {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        #restartButton:active {
            transform: scale(0.95);
        }

        #restartButton:hover {
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.6);
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .status {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
            min-height: 20px;
        }

        .volume-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .volume-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .volume-meter {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 60px;
            gap: 3px;
            margin-bottom: 10px;
        }

        .volume-bar {
            width: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .volume-bar.active {
            background: linear-gradient(180deg, #f5576c 0%, #f093fb 50%, #667eea 100%);
        }

        .volume-bar:nth-child(1) { height: 20%; }
        .volume-bar:nth-child(2) { height: 30%; }
        .volume-bar:nth-child(3) { height: 40%; }
        .volume-bar:nth-child(4) { height: 50%; }
        .volume-bar:nth-child(5) { height: 60%; }
        .volume-bar:nth-child(6) { height: 70%; }
        .volume-bar:nth-child(7) { height: 80%; }
        .volume-bar:nth-child(8) { height: 90%; }
        .volume-bar:nth-child(9) { height: 95%; }
        .volume-bar:nth-child(10) { height: 100%; }

        .volume-percentage {
            font-size: 24px;
            font-weight: bold;
            color: #764ba2;
        }

        .volume-debug {
            font-size: 10px;
            color: #999;
            margin-top: 5px;
        }

        .settings-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .settings-title {
            font-size: 14px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .setting-row:last-child {
            margin-bottom: 0;
        }

        .setting-label {
            font-size: 13px;
            color: #666;
            flex: 1;
            text-align: left;
        }

        .setting-input {
            width: 80px;
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            transition: border-color 0.2s;
        }

        .setting-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .setting-unit {
            font-size: 12px;
            color: #999;
            margin-left: 5px;
            width: 30px;
        }

        .install-prompt {
            display: none;
            margin-top: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }

        .install-prompt.show {
            display: block;
        }

        @media (max-width: 360px) {
            .container {
                padding: 20px 15px;
            }

            h1 {
                font-size: 20px;
            }

            #playButton {
                width: 80px;
                height: 80px;
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Riproduttore Inno</h1>

        <div class="track-info">
            <p class="track-title">Academic Festival Overture, Op. 80</p>
            <p class="track-subtitle">Maestoso (parte finale)</p>
            <p class="track-artist">Berliner Philharmoniker dir. Claudio Abbado</p>
            <p class="track-description">Inno dell'Università degli Studi di Firenze<br>per la proclamazione delle lauree</p>
        </div>

        <div class="controls-row">
            <button id="restartButton" title="Ricomincia da capo">↺</button>
            <button id="playButton">▶</button>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="status" id="status">Premi per iniziare</div>

        <div class="volume-section">
            <div class="volume-label">Volume</div>
            <div class="volume-meter" id="volumeMeter">
                <div class="volume-bar active"></div>
                <div class="volume-bar active"></div>
                <div class="volume-bar active"></div>
                <div class="volume-bar active"></div>
                <div class="volume-bar active"></div>
                <div class="volume-bar active"></div>
                <div class="volume-bar active"></div>
                <div class="volume-bar active"></div>
                <div class="volume-bar active"></div>
                <div class="volume-bar active"></div>
            </div>
            <div class="volume-percentage" id="volumePercentage">100%</div>
            <div class="volume-debug" id="volumeDebug">Vol. reale: 56%</div>
        </div>

        <div class="settings-section">
            <div class="settings-title">Impostazioni Volume</div>
            <div class="setting-row">
                <span class="setting-label">Incremento massimo</span>
                <input type="number" id="volumeIncrement" class="setting-input" value="100" min="0" max="100">
                <span class="setting-unit">%</span>
            </div>
            <div class="setting-row">
                <span class="setting-label">Inizio incremento</span>
                <input type="number" id="fadeTime" class="setting-input" value="35" min="1" max="60">
                <span class="setting-unit">sec</span>
            </div>
            <div class="setting-row">
                <span class="setting-label">Fine incremento</span>
                <input type="number" id="fadeEndTime" class="setting-input" value="25" min="0" max="60">
                <span class="setting-unit">sec</span>
            </div>
        </div>

        <div class="install-prompt" id="installPrompt">
            Tocca per installare l'app
        </div>
    </div>

    <audio id="audio" preload="auto">
        <source src="inno.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Elements
        const playButton = document.getElementById('playButton');
        const restartButton = document.getElementById('restartButton');
        const audio = document.getElementById('audio');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const volumeMeter = document.getElementById('volumeMeter');
        const volumePercentage = document.getElementById('volumePercentage');
        const volumeIncrementInput = document.getElementById('volumeIncrement');
        const fadeTimeInput = document.getElementById('fadeTime');
        const fadeEndTimeInput = document.getElementById('fadeEndTime');
        const installPrompt = document.getElementById('installPrompt');
        const volumeDebug = document.getElementById('volumeDebug');

        let isPlaying = false;
        let deferredPrompt = null;

        // Play/Pause button
        playButton.addEventListener('click', function() {
            if (!isPlaying) {
                audio.play();
                isPlaying = true;
                playButton.textContent = '⏸';
                playButton.classList.add('playing');
                status.textContent = 'In riproduzione...';
            } else {
                audio.pause();
                isPlaying = false;
                playButton.textContent = '▶';
                playButton.classList.remove('playing');
                status.textContent = 'In pausa';
            }
        });

        // Restart button
        restartButton.addEventListener('click', function() {
            audio.currentTime = 0;
            // Reset to base volume
            const maxIncrement = parseFloat(volumeIncrementInput.value) || 100;
            const baseVolume = 1.0 / (1 + maxIncrement / 100);
            audio.volume = baseVolume;
            updateVolumeMeter(100, baseVolume);

            if (!isPlaying) {
                audio.play();
                isPlaying = true;
                playButton.textContent = '⏸';
                playButton.classList.add('playing');
            }

            status.textContent = 'Ricominciato da capo';
        });

        // Click on progress bar to seek
        progressContainer.addEventListener('click', function(e) {
            const rect = progressContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const width = rect.width;
            const percentage = clickX / width;

            audio.currentTime = percentage * audio.duration;
        });

        // Update volume meter visual
        function updateVolumeMeter(percentage, realVolume) {
            const bars = volumeMeter.querySelectorAll('.volume-bar');
            const activeBars = Math.round((percentage / 180) * 10); // Scale to 180% max

            bars.forEach((bar, index) => {
                if (index < activeBars) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            });

            volumePercentage.textContent = `${Math.round(percentage)}%`;
            if (realVolume !== undefined) {
                volumeDebug.textContent = `Vol. reale: ${Math.round(realVolume * 100)}%`;
            }
        }

        audio.addEventListener('loadedmetadata', function() {
            console.log('Durata audio:', audio.duration, 'secondi');
            // Set initial base volume
            const maxIncrement = parseFloat(volumeIncrementInput.value) || 100;
            const baseVolume = 1.0 / (1 + maxIncrement / 100);
            audio.volume = baseVolume;
            updateVolumeMeter(100, baseVolume);
        });

        audio.addEventListener('timeupdate', function() {
            const currentTime = audio.currentTime;
            const duration = audio.duration;

            if (!duration) return;

            // Update progress bar
            const progressPercent = (currentTime / duration) * 100;
            progressBar.style.width = `${progressPercent}%`;

            const timeRemaining = duration - currentTime;

            // Get settings values
            const fadeStartTime = parseFloat(fadeTimeInput.value) || 35;
            const fadeEndTime = parseFloat(fadeEndTimeInput.value) || 25;
            const maxIncrement = parseFloat(volumeIncrementInput.value) || 100;

            // Calculate base volume so that increment reaches 1.0
            // e.g., 80% increment: baseVolume = 1.0 / 1.8 = 0.556
            const baseVolume = 1.0 / (1 + maxIncrement / 100);
            const fadeDuration = fadeStartTime - fadeEndTime;

            // Volume fade in final seconds
            if (timeRemaining <= fadeStartTime && timeRemaining > fadeEndTime && fadeDuration > 0) {
                const fadeProgress = 1 - ((timeRemaining - fadeEndTime) / fadeDuration);
                // Increase from baseVolume to 1.0
                const currentVolume = baseVolume + (fadeProgress * (1.0 - baseVolume));
                audio.volume = currentVolume;

                // Display percentage relative to base (100% at start, up to 100+increment at end)
                const displayPercentage = (currentVolume / baseVolume) * 100;
                updateVolumeMeter(displayPercentage, currentVolume);
            } else if (timeRemaining <= fadeEndTime) {
                // After fade end, keep at max volume
                audio.volume = 1.0;
                updateVolumeMeter(100 + maxIncrement, 1.0);
            } else {
                audio.volume = baseVolume;
                if (timeRemaining > fadeStartTime) {
                    updateVolumeMeter(100, baseVolume);
                }
            }

            // Update time remaining
            if (isPlaying) {
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = Math.floor(timeRemaining % 60);
                status.textContent = `Tempo rimanente: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        });

        audio.addEventListener('ended', function() {
            isPlaying = false;
            playButton.textContent = '▶';
            playButton.classList.remove('playing');
            status.textContent = 'Completato - Premi per ricominciare';
            progressBar.style.width = '0%';
            audio.currentTime = 0;
            // Reset to base volume
            const maxIncrement = parseFloat(volumeIncrementInput.value) || 100;
            const baseVolume = 1.0 / (1 + maxIncrement / 100);
            audio.volume = baseVolume;
            updateVolumeMeter(100, baseVolume);
        });

        audio.addEventListener('error', function(e) {
            status.textContent = 'Errore nel caricamento del file';
            console.error('Errore audio:', e);
        });

        // PWA Install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.classList.add('show');
        });

        installPrompt.addEventListener('click', async () => {
            if (!deferredPrompt) return;

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                installPrompt.classList.remove('show');
            }

            deferredPrompt = null;
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrato:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Registrazione Service Worker fallita:', error);
                    });
            });
        }
    </script>
</body>
</html>
